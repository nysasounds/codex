name: CI

run-name: ${{ github.actor }} CI

on:
  pull_request:

defaults:
  run:
    shell: 'bash -Eeuo pipefail -x {0}'

jobs:
  snap:
    name: Snap
    runs-on: ubuntu-24.04
    steps:

      - run: echo "üéâ Event triggered by ${{ github.event_name }}"
      - run: echo "üêß Job running on ${{ runner.os }}"
      - run: echo "üîé Running on repo ${{ github.repository }} from ${{ github.ref }}"

      - name: Check Out
        uses: actions/checkout@v4

      - name: Build
        # https://github.com/snapcore/action-build/releases
        uses: snapcore/action-build@v1.3.0
        with:
          snapcraft-args: pack --output codex.snap

      - run: echo "üçè Job status ${{ job.status }}"

      - name: Upload
        if: github.repository == 'nysasounds/codex'
        uses: actions/upload-artifact@v4
        with:
          name: codex.snap
          path: codex.snap

      - run: echo "üçè Job status ${{ job.status }}"

  test:
    name: Test
    runs-on: ubuntu-24.04
    needs: snap
    steps:

      - name: Download
        uses: actions/download-artifact@v4
        with:
          name: codex.snap

      - run: echo "üçè Job status ${{ job.status }}"

      - name: Install
        run: |
          # Install #
          sudo snap install --dangerous ./codex.snap

          # Connections #
          sudo snap connect codex:desktop :desktop
          sudo snap connect codex:home :home
          sudo snap connect codex:network :network
          sudo snap connect codex:network-bind :network-bind

      - run: echo "üçè Job status ${{ job.status }}"

      - name: Basic Verify
        run: |
          codex --version

      - run: echo "üçè Job status ${{ job.status }}"

      - name: Snap Basic
        run: |
          # Make sure it basically runs
          codex help |grep -E "^Codex CLI"
          # Make sure there's no warnings #
          _WARNINGS="$(codex help login >/dev/null)"
          [ -z "${_WARNINGS}" ] || echo "${_WARNINGS}"
          [ -z "${_WARNINGS}" ] || exit 1

      - run: echo "üçè Job status ${{ job.status }}"
